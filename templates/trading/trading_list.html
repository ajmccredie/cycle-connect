{% extends 'base3.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="trading-post-sort">
    <a href="{% url 'trading_new' %}" class="btn btn-edit">Create New Post</a>
</div>

<form method="get" action="{% url 'trading_list' %}">
    <select name="category">
        <option value="">All Categories</option>
        {% for value, name in categories %}
        <option value="{{ value }}">{{ name }}</option>
        {% endfor %}
    </select>
    <select name="condition">
        <option value="">All Conditions</option>
        {% for value, name in conditions %}
        <option value="{{ value }}">{{ name }}</option>
        {% endfor %}
    </select>
    <button type="submit">Filter</button>
</form>

<div class="posts">
    {% for post in trading_posts %}
    <div class="post">
        <h2>{{ post.title }} - {{ post.get_status_display }} </h2>
        <p>Seller: {{ post.seller.username }}</p>
        {% if user.is_authenticated and post.seller == user %}
        <a class="btn btn-edit" href="{% url 'trading_edit' post.id %}">Edit</a>
        <a class="btn btn-edit" href="{% url 'trading_delete' post.id %}">Delete</a>
        {% endif %}
        <p>Condition: {{ post.get_condition_display }} - Category: {{ post.get_category_display }}</p>
        <img src="{{ post.image.url }}" alt="Image of {{ post.title }}">
        <p>{{ post.description }}</p>
        {% if not post.approved %}
        <span class="label label-warning">Pending Approval</span>
        {% endif %}
        {% if user.is_authenticated and post.seller == user %}
        <form action="{% url 'toggle_post_status' post.id %}" method="POST">
            {% csrf_token %}
            <button type="submit" class="btn-toggle-status">
                {% if post.status == 'available' %}
                Mark as Sold
                {% else %}
                Mark as Available
                {% endif %}
            </button>
        </form>
        {% endif %}
        <div class="conversation-count">
            <p><i class="fas fa-comments"></i> {{ post.conversation_count }}</p>
        </div>
        {% if user.is_authenticated and user != post.seller %}
        {% if post.has_conversation %}
        <a class="btn btn-edit" href="{% url 'view_conversation' conversation_id=post.conversation_id %}">Continue
            Conversation</a>
        {% else %}
        <a class="btn btn-edit" href="{% url 'start_conversation' post_id=post.id %}">Start Conversation</a>
        {% endif %}
        {% endif %}
        {% if user == post.seller %}
        {% for conversation in post.conversations.all %}
        <a href="{% url 'view_conversation' conversation_id=conversation.id %}">
            Chat with {{ conversation.buyer.username }}
        </a>
        {% endfor %}
        {% endif %}
    </div>
    {% empty %}
    <p>No posts available.</p>
    {% endfor %}
</div>

{% endblock %}